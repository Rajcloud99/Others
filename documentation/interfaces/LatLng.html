<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>LMS-Lite documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">LMS-Lite documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li>Interfaces</li>
  <li
  >
  LatLng</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/modules/live-track/live-track.component.ts</code>
        </p>




        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#lat" 
>
                                            lat
                                        </a>
                                </li>
                                <li>
                                        <a href="#lng" 
>
                                            lng
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#rotation" 
>
                                            rotation
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="lat"></a>
                                        <span class="name "><b>lat</b>
                                            <a href="#lat">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>lat:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="lng"></a>
                                        <span class="name "><b>lng</b>
                                            <a href="#lng">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>lng:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="rotation"></a>
                                        <span class="name "><b>rotation</b>
                                            <a href="#rotation">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>rotation:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Component, OnDestroy, OnInit } from &#x27;@angular/core&#x27;;
import { ActivatedRoute, Router } from &#x27;@angular/router&#x27;;
import { Subscription } from &#x27;rxjs&#x27;;
import { MasterService } from &#x27;../master.service&#x27;;
import { CommonService } from &#x27;src/app/services/common.service&#x27;;
import { ConstantService } from &#x27;src/app/services/constant.service&#x27;;
import { StorageService } from &#x27;src/app/services/storage.service&#x27;;
import { WebsocketService } from &#x27;src/app/services/websocket.service&#x27;;

interface Marker {
  lat: number;
  lng: number;
  icon?: string;
  label?: string;
  eta?: string;
  address?: string;
  draggable?: boolean;
  etaUnit?: string;
  dist?: number|string;
  distUnit?: string;
}
interface LatLng {
  lat: number;
  lng: number;
  rotation?: number;
}

interface Polyline {
  color: string;
  latLng: LatLng[]
}

interface drawLine {
  color: string;
  latLng: LatLng[]
}

@Component({
  selector: &#x27;app-live-track&#x27;,
  templateUrl: &#x27;./live-track.component.html&#x27;,
  styleUrls: [&#x27;./live-track.component.scss&#x27;]
})
export class LiveTrackComponent implements OnInit, OnDestroy {
  vehData: any &#x3D; [];
  polyLine: Polyline &#x3D; {
    color: &#x27;#2196f3&#x27;,
    latLng: [],
  };
  drawLine: Polyline &#x3D; {
    color: &#x27;#2196f3&#x27;,
    latLng: []
  };
  map: any;
  receivedAllDevice:any;
  isOpen &#x3D; false;
  zoom: number &#x3D; 15;
  innerWidth &#x3D; window.innerWidth;
  marker: Marker &#x3D; {
    lat: 23.673858,
    lng: 83.815982,
  };
  lat: any;
  lng: any;
  device: any;
  address: any;
  positionTime: any;
  f_lvl: any;
  setColor &#x3D; {&quot;running&quot;: &quot;#15e425&quot;, &quot;online&quot;: &quot;#15e425&quot;, &quot;stopped&quot;: &quot;red&quot;, &quot;offline&quot;: &quot;grey&quot;};

  private _sktresSub: Subscription &#x3D; new Subscription;// socket response subscription
  deltaLat: any;
  deltaLng: any;
  numDeltas &#x3D; 400; // iteration
  delay &#x3D; 600; //miliseconds
  truck_path: string;
  truckIcon: any;
  speed: any;
  datetime: any;
  timerRef: any;
  constructor(
    private route: ActivatedRoute,
    private router: Router,
    private ws: WebsocketService,
    private storageService: StorageService,
    private masterService: MasterService,
    private constantService: ConstantService,
    private commonService: CommonService
  ) {
    this.route.params.subscribe(queryParam &#x3D;&gt; {
      if(queryParam._id) {
        const currentState &#x3D; this.router.getCurrentNavigation();
        this.vehData &#x3D; currentState &amp;&amp; currentState.extras.state;
        if(!this.vehData){
          let vehicles &#x3D; this.storageService.get(&#x27;allVehicles&#x27;);
          if(vehicles) {
            let vehicledata &#x3D; vehicles.find((x: { _id: any; }) &#x3D;&gt; x._id &#x3D;&#x3D; queryParam._id);
            if(vehicledata){
              this.vehData &#x3D; vehicledata.vehicle;
            }else{
              this.commonService.goBack();
            }
          }else{
             this.commonService.goBack();
          }
        }
      }
    });
    this.truck_path &#x3D; this.constantService.constants.truck_path;
  }
  ngOnDestroy(): void {
    this._sktresSub.unsubscribe();
    if(this.timerRef) {
      clearTimeout(this.timerRef);
      this.timerRef &#x3D; undefined;
    }
  }

  ngOnInit(): void {
    this.getDevices();
    this.truckIcon &#x3D; {
      path: this.truck_path,
      fillColor: &quot;#15e425&quot;,
      fillOpacity: 0.8,
      strokeWeight: 0.5,
      scale: 0.5,
      rotation: 90
    };
  }

  getDevices(){
    this.masterService.getGpsReports({},&#x27;devices&#x27;).subscribe((res: any) &#x3D;&gt; {
        this.receivedAllDevice &#x3D; res.data;
        if(this.receivedAllDevice &amp;&amp; this.receivedAllDevice.length){
          this.getLiveData();
        }else{
          this.commonService.error(&#x27;No devices found&#x27;);
        }

      });
  }

  setTruckIcon(angle: any,color: any) {
    this.truckIcon &#x3D; {
      path: this.truck_path,
      fillColor: color || &quot;#15e425&quot;,
      fillOpacity: 0.8,
      strokeWeight: 0.5,
      scale: 0.5,
      rotation: angle &amp;&amp; parseFloat(angle) || 90
    };
  }

  setCenter(lat: number, lng: number){
    this.map &amp;&amp; this.map.setCenter({ lat, lng});
  }

  mapReady(map: any){
    this.map &#x3D; map;
    this.setCenter(this.marker.lat, this.marker.lng);
  }

  moveMarker(){
    if(!this.polyLine || !this.drawLine) return;
    for(let i&#x3D;0;i&lt;this.numDeltas;i++){
      const mContext &#x3D; this;
      this.timerRef &#x3D; setTimeout(() &#x3D;&gt; {
        let newLat &#x3D; this.polyLine.latLng[this.polyLine.latLng.length - 2].lat +&#x3D; this.deltaLat;
        let newLng &#x3D; this.polyLine.latLng[this.polyLine.latLng.length - 2].lng +&#x3D; this.deltaLng;
        if(i%2 &#x3D;&#x3D;&#x3D; 0)
        mContext.drawLine.latLng.push({lat: newLat, lng: newLng});
        // console.info(new Date());
        mContext.marker.lat &#x3D; newLat;
        mContext.marker.lng &#x3D; newLng;
      }, mContext.delay);
    }
  }

  stopFeed(sDevice: any) {
    if(!this.device) return;
    let req : any &#x3D; {};
    req.device_id &#x3D; sDevice.imei;
    req.device_type &#x3D; sDevice.device_type;
    req.user_id &#x3D; this.storageService.get(&#x27;userData&#x27;).client_config.gpsId;
    req.request&#x3D; &#x27;stop_feed&#x27;;
    this.ws.sendMessage(req);
  }

  getLiveData() {
    //let allDevices &#x3D; this.storageService.get(&#x27;alldevices&#x27;);
    const imei &#x3D; this.vehData?.device_imei ? this.vehData?.device_imei : this.vehData?.device?.imei;
    this.device &#x3D; this.receivedAllDevice &amp;&amp; this.receivedAllDevice.length &amp;&amp; this.receivedAllDevice.find((item: any) &#x3D;&gt; item.imei &#x3D;&#x3D; imei);
    if(!this.device &amp;&amp; !imei) return;
    let stopDevice &#x3D; this.storageService.get(&#x27;lastDevice&#x27;);
    if(stopDevice &amp;&amp; (this.device?.imei||imei) !&#x3D; stopDevice.imei) {
      this.stopFeed(stopDevice);
    }
    this.storageService.put(&#x27;lastDevice&#x27;,this.device);
    let req : any &#x3D; {};
    req.device_id &#x3D; this.device &amp;&amp; this.device.imei || imei;
    req.device_type &#x3D; this.device &amp;&amp; this.device.device_type || this.vehData.device_type;
    req.user_id &#x3D; this.storageService.get(&#x27;userData&#x27;).client_config.gpsId;
    req.request &#x3D; &#x27;live_feedV2&#x27;;
    this.ws.sendMessage(req);
    this._sktresSub &#x3D; this.ws.getMessage().subscribe((res: any) &#x3D;&gt; {
      if(res) console.info(new Date(),this.vehData.vehicle_reg_no,res);
      if(!res || res.request !&#x3D; &#x27;live_feedV2&#x27; || (res.data &amp;&amp; Number(res.data?.device_id) !&#x3D; Number(this.device?.imei||imei))) return;
      this.address &#x3D; res.data?.address || res.data?.addr;
      this.speed &#x3D; res.data?.speed;
      this.datetime &#x3D; res.data?.datetime;
      this.positionTime &#x3D; res.data?.positioning_time;
      this.f_lvl &#x3D; res.data?.f_lvl;
      let positionTime : number &#x3D; new Date(res?.data?.positioning_time).getTime();
      let locationTime: number &#x3D; new Date(res?.data?.location_time).getTime();
      let stoppageTime &#x3D; 10;
      let ptDiffMin &#x3D; Math.ceil((new Date().getTime() - positionTime) / 60000); // in Min
      let ltDiffMin &#x3D; Math.ceil((new Date().getTime() - locationTime) / 60000); // in Min
      if(res &amp;&amp; res.data) {
        if (ptDiffMin &amp;&amp; ptDiffMin &lt; 300) {//5 hr no offline
          if (ltDiffMin &amp;&amp; ltDiffMin &lt;&#x3D; stoppageTime &amp;&amp; res?.data?.speed &gt; 0) {
              res.data.status &#x3D; &quot;running&quot;;
          } else {
            res.data.status &#x3D; &quot;stopped&quot;;
          }
        } else {
            res.data.status &#x3D; &quot;offline&quot;;
        }
      }
      if(res?.data?.status &#x3D;&#x3D; &#x27;stopped&#x27;) {
        let color &#x3D; this.setColor[&#x27;stopped&#x27;];
        this.setTruckIcon(res?.data?.course,color);
      } else if(res?.data?.status &#x3D;&#x3D; &#x27;running&#x27;) {
        let color &#x3D; this.setColor[&#x27;running&#x27;];
        this.setTruckIcon(res?.data?.course,color);
      } else if(res?.data?.status &#x3D;&#x3D; &#x27;offline&#x27;) {
        let color &#x3D; this.setColor[&#x27;offline&#x27;];
        this.setTruckIcon(res?.data?.course,color);
      }
      if(res &amp;&amp; res.data){
        this.pushCurrentLoc({lat:res.data.lat,lng:res.data.lng,address:res.data?.address,eta:res.data?.positioning_time});
      }
    });
  }

  transition() {
    let len &#x3D; this.polyLine.latLng.length;
    this.deltaLat &#x3D; (this.polyLine.latLng[len-1].lat - this.polyLine.latLng[len-2].lat)/this.numDeltas;
    this.deltaLng &#x3D; (this.polyLine.latLng[len-1].lng - this.polyLine.latLng[len-2].lng)/this.numDeltas;
    this.moveMarker();
  }
  pushCurrentLoc({lat, lng}: any){
    if(lat &amp;&amp; lng) {
      this.polyLine.latLng.push({lat, lng});
      this.lat &#x3D; lat;
      this.lng &#x3D; lng;
    }
    if(this.polyLine.latLng.length &gt; 1)
      this.transition();
    else {
      this.marker.lat &#x3D; lat;
      this.marker.lng &#x3D; lng;
    }
  }
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'LatLng.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
